/**
 * Trace Serviceï¼šæ ¸å¿ƒæº¯æºé€»è¾‘
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼šä»ç”¨æˆ·ç‚¹å‡»ä½ç½®åå‘è¿½è¸ªæ•°æ®æ¥æº
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“š æŠ€æœ¯èƒŒæ™¯ï¼šä»€ä¹ˆæ˜¯æ•°æ®æº¯æºï¼Ÿ
 *
 * ç”¨æˆ·åœ¨é¡µé¢ä¸Šç‚¹å‡»ä¸€ä¸ªå…ƒç´ ï¼ˆå¦‚æ˜¾ç¤ºé‡‘é¢çš„ <span>ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å›ç­”ï¼š
 * - è¿™ä¸ªæ•°æ®æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ
 * - ç»è¿‡äº†å“ªäº›ç»„ä»¶çš„ä¼ é€’ï¼Ÿ
 * - æœ€ç»ˆçš„æ•°æ®æºæ˜¯ APIã€Vuex è¿˜æ˜¯å†™æ­»çš„ï¼Ÿ
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“Š å®Œæ•´è¿½è¸ªæµç¨‹å›¾ï¼š
 *
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  ç”¨æˆ·ç‚¹å‡»ï¼š<span>{{ amount }}</span>                        â”‚
 *   â”‚  ä½ç½®ï¼šsrc/views/Dashboard.vue ç¬¬ 42 è¡Œ                     â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *                           â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  Step 1: è§£æ Vue æ–‡ä»¶ï¼Œå®šä½ AST èŠ‚ç‚¹                       â”‚
 *   â”‚  ä½¿ç”¨ templateAST.js çš„ findNodeInTemplate                 â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *                           â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  Step 2: æå–å˜é‡                                           â”‚
 *   â”‚  ä½¿ç”¨ variableAST.js çš„ getUniversalVariables              â”‚
 *   â”‚  ç»“æœï¼š['amount']                                           â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *                           â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  Step 3: ä»£ç æçº¯                                           â”‚
 *   â”‚  ä½¿ç”¨ scriptAST.js çš„ pruneScript                          â”‚
 *   â”‚  åªä¿ç•™ä¸ amount ç›¸å…³çš„ä»£ç                                  â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *                           â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  Step 4: åˆ¤æ–­æ•°æ®æ¥æº                                       â”‚
 *   â”‚  - æ¥è‡ª propsï¼Ÿ â†’ ç»§ç»­è¿½è¸ªçˆ¶ç»„ä»¶                            â”‚
 *   â”‚  - æ¥è‡ª Vuexï¼Ÿ  â†’ è¿½è¸ª Store å®šä¹‰                           â”‚
 *   â”‚  - æ¥è‡ª dataï¼Ÿ  â†’ è¿½è¸ªèµ‹å€¼è¯­å¥                              â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *              â–¼                         â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  æ¥è‡ª props      â”‚      â”‚  æ‰¾åˆ°æ•°æ®æºï¼ˆAPI/Vuex/é™æ€ï¼‰     â”‚
 *   â”‚  â†“               â”‚      â”‚  â†’ ç»“æŸè¿½è¸ª                      â”‚
 *   â”‚  æŸ¥æ‰¾çˆ¶ç»„ä»¶      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *   â”‚  (WebpackService)â”‚
 *   â”‚  â†“               â”‚
 *   â”‚  å›åˆ° Step 1     â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *                           â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  Step 5: æ„å»ºè¿½è¸ªé“¾                                         â”‚
 *   â”‚  traceChain = [å­ç»„ä»¶ä¿¡æ¯, çˆ¶ç»„ä»¶ä¿¡æ¯, ...]                â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                           â”‚
 *                           â–¼
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  Step 6: è°ƒç”¨ AI åˆ†æ                                       â”‚
 *   â”‚  æŠŠæçº¯åçš„ä»£ç å‘ç»™å¤§æ¨¡å‹ï¼Œç”Ÿæˆç»“æ„åŒ–åˆ†ææŠ¥å‘Š               â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“Š è¿½è¸ªé“¾ç¤ºä¾‹ï¼š
 *
 *   ç”¨æˆ·ç‚¹å‡» ChartCard ç»„ä»¶ä¸­çš„ amountï¼š
 *
 *   traceChain = [
 *     {
 *       file: 'src/components/ChartCard.vue',
 *       tag: 'span',
 *       source: '<span>{{ amount }}</span>',
 *       prunedScript: 'props: { amount: Number }',
 *       callSnippet: ''
 *     },
 *     {
 *       file: 'src/views/Dashboard.vue',
 *       tag: 'ChartCard',
 *       source: '<ChartCard :amount="totalAmount" />',
 *       prunedScript: 'computed: { totalAmount() { return this.data.amount } }',
 *       callSnippet: '<ChartCard :amount="totalAmount" />'
 *     }
 *   ]
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

'use strict';

const Service = require('egg').Service;
const fs = require('fs');
const path = require('path');

const { findNodeInTemplate } = require('../lib/templateAST');
const { pruneScript } = require('../lib/scriptAST');
const { getUniversalVariables, getCategorizedVariables } = require('../lib/variableAST');
const webpackService = require('../lib/WebpackService');
const {
  isFromProps,
  findBindingInParent,
  findVuexDefinition,
  getVuexSource,
  findMutationTriggers,
  rankVariablesByPriority,
} = require('../lib/utils/traceUtils');
const { parseSfcTemplate, normalizeLineColumn } = require('../lib/sfcTemplate');

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// å¸¸é‡å®šä¹‰
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/**
 * æœ€å¤§è¿½è¸ªæ·±åº¦
 * é˜²æ­¢å¾ªç¯å¼•ç”¨å¯¼è‡´æ— é™å¾ªç¯
 */
const MAX_TRACE_DEPTH = 10;

class TraceService extends Service {
  /**
   * åˆ†æå…¥å£ï¼šä»ç”¨æˆ·ç‚¹å‡»ä½ç½®æº¯æºåˆ°æ•°æ®æºå¤´ï¼Œå¹¶è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆç»“æ„åŒ–åˆ†æ
   * @param {Object} params
   * @param {string} params.path ç›¸å¯¹é¡¹ç›®æ ¹ç›®å½•çš„ Vue æ–‡ä»¶è·¯å¾„
   * @param {number} params.line 1-based è¡Œå·
   * @param {number} params.column 0-based åˆ—å·
   *
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   * ğŸ“ å‚æ•°è¯´æ˜
   *
   * è¿™äº›å‚æ•°æ¥è‡ªå‰ç«¯çš„ code-inspector-plugin æ’ä»¶ï¼š
   * - path: ç”¨æˆ·ç‚¹å‡»çš„å…ƒç´ æ‰€åœ¨çš„ Vue æ–‡ä»¶è·¯å¾„
   * - line: å…ƒç´ åœ¨æ–‡ä»¶ä¸­çš„è¡Œå·ï¼ˆä» 1 å¼€å§‹ï¼‰
   * - column: å…ƒç´ åœ¨è¡Œä¸­çš„åˆ—å·ï¼ˆä» 0 å¼€å§‹ï¼‰
   *
   * ğŸ“Š ç¤ºä¾‹ï¼š
   *   ç”¨æˆ·ç‚¹å‡»äº† src/views/Dashboard.vue ç¬¬ 42 è¡Œçš„ä¸€ä¸ª span
   *   å‚æ•°ï¼š{ path: 'src/views/Dashboard.vue', line: 42, column: 8 }
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   */
  async analyze({ path: currentRelativePath, line, column }) {
    const { ctx, app } = this;

    // é¡¹ç›®æ ¹ç›®å½•ï¼ˆç”¨äºæ‹¼æ¥å®Œæ•´è·¯å¾„ï¼‰
    const projectRoot = app.config.projectRoot;

    // è¿½è¸ªé“¾ï¼šè®°å½•ä»å­ç»„ä»¶åˆ°çˆ¶ç»„ä»¶çš„å®Œæ•´è¿½è¸ªè·¯å¾„
    const traceChain = [];

    // å½“å‰è¿½è¸ªçš„ä½ç½®ï¼ˆä¼šéšç€å‘ä¸Šè¿½è¸ªè€Œæ”¹å˜ï¼‰
    let currentLine = Number.isFinite(line) ? line : NaN;
    let currentColumn = Number.isFinite(column) ? column : NaN;

    // è¿­ä»£è®¡æ•°å™¨ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
    let iteration = 0;

    /**
     * è°ƒç”¨ç‰‡æ®µä¼ é€’æœºåˆ¶
     *
     * ğŸ“ åœºæ™¯ï¼šå­ç»„ä»¶çš„å˜é‡æ¥è‡ª propsï¼Œéœ€è¦è¿½è¸ªåˆ°çˆ¶ç»„ä»¶
     *
     * å½“æˆ‘ä»¬åœ¨çˆ¶ç»„ä»¶ä¸­æ‰¾åˆ° <ChildComponent :amount="xxx" /> æ—¶ï¼Œ
     * éœ€è¦æŠŠè¿™æ®µä»£ç ä¿å­˜ä¸‹æ¥ï¼Œåœ¨ä¸‹ä¸€è½®è¿­ä»£ä¸­ä½œä¸º callSnippet å±•ç¤ºã€‚
     *
     * è¿™æ · AI å°±èƒ½çœ‹åˆ°å®Œæ•´çš„æ•°æ®æµï¼š
     * çˆ¶ç»„ä»¶çš„ xxx -> å­ç»„ä»¶çš„ props.amount -> å­ç»„ä»¶æ¨¡æ¿ä¸­çš„ {{ amount }}
     */
    let nextCallSnippet = '';

    while (currentRelativePath && iteration < MAX_TRACE_DEPTH) {
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      // Phase 1: è¯»å–å¹¶è§£æ Vue æ–‡ä»¶
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      const fullPath = path.join(projectRoot, currentRelativePath);
      if (!fs.existsSync(fullPath)) break;

      const fileContent = fs.readFileSync(fullPath, 'utf-8');

      /**
       * åæ ‡è§„èŒƒåŒ–
       *
       * ğŸ“ é—®é¢˜ï¼šç”¨æˆ·ç‚¹å‡»å¯èƒ½è½åœ¨è¡Œå°¾ç©ºç™½å¤„
       * è§£å†³ï¼šæŠŠ column é™åˆ¶åˆ°æœ¬è¡Œæœ€åä¸€ä¸ªéç©ºç™½å­—ç¬¦
       */
      const normalized = normalizeLineColumn(fileContent, currentLine, currentColumn);
      currentLine = normalized.line;
      currentColumn = normalized.column;

      // è§£æ Vue SFCï¼ˆå•æ–‡ä»¶ç»„ä»¶ï¼‰
      const parsed = parseSfcTemplate({
        projectRoot,
        fileContent,
        filename: currentRelativePath,
      });
      if (!parsed || !parsed.descriptor || !parsed.descriptor.template) break;

      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      // Phase 2: å®šä½æ¨¡æ¿ä¸­çš„ç›®æ ‡èŠ‚ç‚¹
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      let targetNode = null;

      if (parsed.kind === 'vue3') {
        /**
         * Vue3 åæ ‡è½¬æ¢
         *
         * Vue3 çš„ template AST è¡Œå·æ˜¯ç›¸å¯¹äº <template> æ ‡ç­¾å†…éƒ¨çš„
         * éœ€è¦ä»æ–‡ä»¶è¡Œå·å‡å» template çš„èµ·å§‹è¡Œå·
         *
         * ç¤ºä¾‹ï¼š
         *   <template>     <- ç¬¬ 10 è¡Œ (descriptor.template.loc.start.line)
         *     <div>        <- ç¬¬ 11 è¡Œ (æ–‡ä»¶) = ç¬¬ 2 è¡Œ (template å†…)
         */
        const templateStartLine = parsed.descriptor.template.loc.start.line;
        const targetLineInTemplate = currentLine - templateStartLine + 1;
        targetNode = findNodeInTemplate(parsed.templateAST, targetLineInTemplate, currentColumn);
      } else {
        /**
         * Vue2 åæ ‡è½¬æ¢
         *
         * Vue2 çš„å¤„ç†æ›´å¤æ‚ï¼Œå› ä¸º component-compiler-utils ä¼šå¯¹æ¨¡æ¿åš de-indent
         * ï¼ˆå»é™¤å…¬å…±ç¼©è¿›ï¼‰ï¼Œå¯¼è‡´åˆ—å·éœ€è¦é¢å¤–è°ƒæ•´
         *
         * æ­¥éª¤ï¼š
         * 1. fileLine -> templateLineï¼ˆå‡å» template èµ·å§‹è¡Œï¼‰
         * 2. fileColumn -> templateColumnï¼ˆå‡å»å…¬å…±ç¼©è¿›ï¼‰
         * 3. å†æ¬¡ normalizeï¼ˆé˜²æ­¢è¶Šç•Œï¼‰
         */
        const templateLine = currentLine - parsed.templateStartLoc.line + 1;
        const columnAdjusted = Math.max(0, currentColumn - (parsed.templateBaseIndent || 0));
        const templateNormalized = normalizeLineColumn(parsed.templateSource, templateLine, columnAdjusted);

        targetNode = findNodeInTemplate(
          parsed.templateAST,
          templateNormalized.line,
          templateNormalized.column,
          null,
          parsed.templateSource
        );
      }

      // æ²¡æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œç»ˆæ­¢è¿½è¸ª
      if (!targetNode) break;

      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      // Phase 3: æå–å˜é‡ï¼ˆä¸‰ç»´åº¦åˆ†ç±»ï¼‰
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      const categorizedVars = getCategorizedVariables(targetNode);
      const entryVars = categorizedVars.all; // ä½¿ç”¨æ‰å¹³åˆ—è¡¨ï¼Œå‘åå…¼å®¹

      /**
       * é™æ€å†…å®¹æ£€æµ‹
       *
       * å¦‚æœæ²¡æœ‰æå–åˆ°ä»»ä½•å˜é‡ï¼Œè¯´æ˜ç”¨æˆ·ç‚¹å‡»çš„æ˜¯å†™æ­»çš„é™æ€æ–‡æœ¬
       * ä¾‹å¦‚ï¼š<span>Alipay</span>
       *
       * è¿™ç§æƒ…å†µç›´æ¥è¿”å›ç»“æœï¼Œä¸éœ€è¦è¿½è¸ªå’Œ AI åˆ†æ
       */
      if (entryVars.length === 0) {
        const staticSource = parsed.getNodeSource(targetNode);
        return this.buildStaticContentResult(currentRelativePath, targetNode.tag, staticSource);
      }

      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      // Phase 4: ä»£ç æçº¯
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      const rawScript = parsed.descriptor.scriptSetup?.content || parsed.descriptor.script?.content || '';
      const prunedScript = pruneScript(rawScript, entryVars);

      // æ„å»ºå½“å‰å±‚çº§çš„è¿½è¸ªä¿¡æ¯
      const stepInfo = {
        file: currentRelativePath,
        tag: targetNode.tag,
        prunedScript,
        source: parsed.getNodeSource(targetNode),
        callSnippet: nextCallSnippet,  // æ¥è‡ªä¸Šä¸€å±‚çš„è°ƒç”¨ç‰‡æ®µ
        categorizedVars,  // æ–°å¢ï¼šä¸‰ç»´åº¦åˆ†ç±»å˜é‡
      };

      // æ¸…ç©ºè°ƒç”¨ç‰‡æ®µï¼ˆå·²è¢«å½“å‰å±‚çº§æ¶ˆè´¹ï¼‰
      nextCallSnippet = '';

      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      // Phase 5: åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­å‘ä¸Šè¿½è¸ªï¼ˆprops æº¯æº - ä¼˜åŒ–ç‰ˆï¼‰
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      /**
       * Props æº¯æºé€»è¾‘ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
       *
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * ğŸ¯ ä¼˜åŒ–ç›®æ ‡ï¼šè§£å†³åªæ£€æŸ¥ç¬¬ä¸€ä¸ªå˜é‡å¯¼è‡´è¿½è¸ªé“¾ä¸å®Œæ•´çš„é—®é¢˜
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       *
       * ğŸ“ é—®é¢˜åœºæ™¯ï¼š
       *
       *   ç”¨æˆ·ç‚¹å‡»ï¼š<div :class="staticClass">{{ amount }}</div>
       *
       *   æ—§é€»è¾‘ï¼šentryVars = ['staticClass', 'amount']
       *          åªæ£€æŸ¥ entryVars[0] = 'staticClass'
       *          å¦‚æœ staticClass ä¸æ˜¯ props â†’ åœæ­¢è¿½è¸ª âŒ
       *          ä½† amount å¯èƒ½æ˜¯ propsï¼Œåº”è¯¥ç»§ç»­è¿½è¸ªï¼
       *
       *   æ–°é€»è¾‘ï¼š
       *   1. æŒ‰ä¼˜å…ˆçº§æ’åºï¼š['amount'(æƒé‡3), 'staticClass'(æƒé‡1.5)]
       *   2. éå†æ‰¾å‡ºæ‰€æœ‰ props å˜é‡
       *   3. é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ props å˜é‡è¿½è¸ª âœ“
       *
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       *
       * å¦‚æœå˜é‡æ¥è‡ª propsï¼Œè¯´æ˜æ•°æ®æ˜¯çˆ¶ç»„ä»¶ä¼ å…¥çš„
       * éœ€è¦ï¼š
       * 1. é€šè¿‡ WebpackService æ‰¾åˆ°çˆ¶ç»„ä»¶
       * 2. åœ¨çˆ¶ç»„ä»¶ä¸­æ‰¾åˆ°è°ƒç”¨å½“å‰ç»„ä»¶çš„ä»£ç 
       * 3. ç»§ç»­åœ¨çˆ¶ç»„ä»¶ä¸­è¿½è¸ª
       */

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Step 5.1: æ™ºèƒ½æ’åºå˜é‡
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // è°ƒç”¨ rankVariablesByPriority æŒ‰ä¼˜å…ˆçº§å¯¹å˜é‡æ’åº
      // ä¼˜å…ˆçº§ï¼šcontent(3) > attributes(2) > æ ·å¼/äº‹ä»¶(1.5) > conditionals(1)
      //
      // ç¤ºä¾‹è¾“å…¥ï¼š
      //   categorizedVars = {
      //     content: [{ variables: ['amount'] }],
      //     attributes: [{ directive: ':class', variables: ['staticClass'] }]
      //   }
      //
      // ç¤ºä¾‹è¾“å‡ºï¼š
      //   rankedVars = ['amount', 'staticClass']
      //   ï¼ˆamount ä¼˜å…ˆï¼Œå› ä¸º content æƒé‡ 3 > :class æƒé‡ 1.5ï¼‰
      const rankedVars = rankVariablesByPriority(categorizedVars);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Step 5.2: ç­›é€‰å‡ºæ‰€æœ‰æ¥è‡ª props çš„å˜é‡
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // éå†æ’åºåçš„å˜é‡ï¼Œè°ƒç”¨ isFromProps() æ£€æŸ¥æ¯ä¸ªå˜é‡æ˜¯å¦åœ¨ props ä¸­å®šä¹‰
      //
      // ç¤ºä¾‹ï¼š
      //   rankedVars = ['amount', 'staticClass', 'localData']
      //   - amount: isFromProps() â†’ true  (åœ¨ props ä¸­)
      //   - staticClass: isFromProps() â†’ true  (åœ¨ props ä¸­)
      //   - localData: isFromProps() â†’ false (åœ¨ data ä¸­)
      //
      //   ç»“æœï¼špropsVars = ['amount', 'staticClass']
      const propsVars = rankedVars.filter(v => isFromProps(rawScript, v));

      let shouldContinue = false;
      let primaryVar = null;

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Step 5.3: é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ props å˜é‡è¿›è¡Œè¿½è¸ª
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // å¦‚æœå­˜åœ¨æ¥è‡ª props çš„å˜é‡ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰è¿›è¡Œè¿½è¸ª
      // ä¿æŒå•é“¾è·¯è¿½è¸ªæ¶æ„ï¼Œå‘åå…¼å®¹
      if (propsVars.length > 0) {
        // propsVars å·²æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå–ç¬¬ä¸€ä¸ªå³ä¸ºæœ€é‡è¦çš„ props å˜é‡
        primaryVar = propsVars[0];

        // æŸ¥æ‰¾å¼•ç”¨å½“å‰ç»„ä»¶çš„çˆ¶ç»„ä»¶ï¼ˆé€šè¿‡ Webpack ä¾èµ–å›¾ï¼‰
        const parents = webpackService.getParents(currentRelativePath);

        if (parents.length > 0) {
          const parentRelativePath = parents[0];
          const parentFullPath = path.resolve(projectRoot, parentRelativePath);
          // è·å–å½“å‰ç»„ä»¶çš„ç±»åï¼ˆç”¨äºåœ¨çˆ¶ç»„ä»¶æ¨¡æ¿ä¸­æŸ¥æ‰¾ï¼‰
          const childClassName = path.basename(currentRelativePath, '.vue');

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Step 5.4: åœ¨çˆ¶ç»„ä»¶ä¸­æŸ¥æ‰¾ prop ç»‘å®š
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // åœ¨çˆ¶ç»„ä»¶æ¨¡æ¿ä¸­æŸ¥æ‰¾ç±»ä¼¼ <ChartCard :amount="xxx" /> çš„ä»£ç 
          // è¿”å› binding å¯¹è±¡åŒ…å«ï¼š
          // - variable: ç»‘å®šçš„è¡¨è¾¾å¼ï¼ˆå¦‚ 'totalAmount'ï¼‰
          // - line/column: åœ¨çˆ¶ç»„ä»¶ä¸­çš„ä½ç½®
          // - rawTag: å®Œæ•´çš„ç»„ä»¶è°ƒç”¨ä»£ç 
          const binding = findBindingInParent(parentFullPath, childClassName, primaryVar);

          if (binding) {
            // ä¿å­˜è°ƒç”¨ç‰‡æ®µï¼Œä¾›ä¸‹ä¸€è½®è¿­ä»£ä½¿ç”¨
            // è¿™æ · AI å°±èƒ½çœ‹åˆ°çˆ¶å­ç»„ä»¶é—´çš„æ•°æ®ä¼ é€’å…³ç³»
            nextCallSnippet = binding.rawTag;

            // æ›´æ–°è¿½è¸ªä½ç½®åˆ°çˆ¶ç»„ä»¶ï¼Œç»§ç»­ä¸‹ä¸€è½®è¿­ä»£
            currentRelativePath = parentRelativePath;
            currentLine = binding.line;
            currentColumn = binding.column;
            shouldContinue = true;
          }
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Step 5.5: è®°å½• props åˆ†æç»“æœï¼ˆç”¨äºè°ƒè¯•å’Œæ‰©å±•ï¼‰
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // å°†åˆ†æä¿¡æ¯é™„åŠ åˆ° stepInfoï¼Œæ–¹ä¾¿ï¼š
      // 1. è°ƒè¯•ï¼šæŸ¥çœ‹å“ªäº›å˜é‡è¢«è¯†åˆ«ä¸º props
      // 2. æ‰©å±•ï¼šæœªæ¥å¯èƒ½éœ€è¦è¿½è¸ªå¤šä¸ª props å˜é‡
      stepInfo.propsAnalysis = {
        allPropsVars: propsVars,        // æ‰€æœ‰æ¥è‡ª props çš„å˜é‡ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        primaryTrackedVar: primaryVar,   // å®é™…è¢«è¿½è¸ªçš„å˜é‡
      };

      // å½“å‰å±‚çº§ä¿¡æ¯å…¥æ ˆ
      traceChain.push(stepInfo);

      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      // Phase 6: Vuex æ•°æ®æº¯æºï¼ˆå¯é€‰ï¼‰
      // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      /**
       * Vuex æº¯æº
       *
       * å¦‚æœå˜é‡æ¥è‡ª Vuexï¼ˆmapState/mapGettersï¼‰ï¼Œ
       * æˆ‘ä»¬è¿˜éœ€è¦è¿½è¸ªåˆ° Store çš„å®šä¹‰ï¼Œæ‰¾å‡ºï¼š
       * - State/Getter çš„å…·ä½“å®ç°
       * - å“ªäº› Mutation ä¼šä¿®æ”¹è¿™ä¸ª State
       * - è¿™äº› Mutation åœ¨å“ªé‡Œè¢«è§¦å‘
       */
      const vuexMapping = findVuexDefinition(stepInfo.prunedScript, entryVars);

      if (vuexMapping) {
        const storeSource = getVuexSource(projectRoot, vuexMapping);

        if (storeSource) {
          // æ„å»º Vuex è¿½è¸ªä¿¡æ¯
          const vuexTraceInfo = this.buildVuexTraceInfo(vuexMapping, storeSource, projectRoot);
          traceChain.push(vuexTraceInfo);

          // Vuex é€šå¸¸å°±æ˜¯æ•°æ®æºå¤´ï¼Œç»ˆæ­¢è¿½è¸ª
          break;
        }
      }

      if (!shouldContinue) break;
      iteration++;
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // Phase 7: æ„é€  AI åˆ†ææ‰€éœ€çš„ä»£ç æ–‡æœ¬
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    /**
     * ä¸ºä»€ä¹ˆè¦ reverseï¼Ÿ
     *
     * traceChain çš„é¡ºåºæ˜¯ï¼š[å­ç»„ä»¶, çˆ¶ç»„ä»¶, ç¥–çˆ¶ç»„ä»¶, ...]
     * ä½†å¯¹äº AI åˆ†æï¼Œæˆ‘ä»¬å¸Œæœ›ä»æ•°æ®æºå¤´å¼€å§‹è®²è¿°ï¼š
     * [ç¥–çˆ¶ç»„ä»¶(æ•°æ®æº), çˆ¶ç»„ä»¶(ä¸­è½¬), å­ç»„ä»¶(å±•ç¤º)]
     *
     * ğŸ“Š ç¤ºä¾‹ï¼š
     *
     *   åŸå§‹é¡ºåºï¼ˆè¿½è¸ªé¡ºåºï¼‰ï¼š
     *   ChartCard.vue â†’ Dashboard.vue â†’ App.vue
     *
     *   åè½¬åï¼ˆæ•°æ®æµé¡ºåºï¼‰ï¼š
     *   App.vue â†’ Dashboard.vue â†’ ChartCard.vue
     */
    const finalCodeForAI = traceChain
      .reverse()
      .map(step => {
        /**
         * æ„å»ºæ¯ä¸ªè¿½è¸ªå±‚çº§çš„ä»£ç ç‰‡æ®µ
         *
         * æ ¼å¼ï¼š
         * // File: src/views/Dashboard.vue
         * // [Template] ç›®æ ‡ DOM å…ƒç´ :
         * <span>{{ amount }}</span>
         *
         * // [Data Flow] æ¨¡æ¿ä¸­è°ƒç”¨å­ç»„ä»¶çš„ä»£ç :
         * <ChartCard :amount="totalAmount" />
         *
         * // [Logic] å…³è”çš„è„šæœ¬é€»è¾‘:
         * computed: { totalAmount() { return this.data.amount } }
         */
        let output = `// File: ${step.file}\n`;

        // æ·»åŠ ç›®æ ‡ DOM å…ƒç´ ï¼Œè®© AI çŸ¥é“æˆ‘ä»¬åœ¨è¿½è¸ªå“ªä¸ªå…ƒç´ 
        if (step.source) {
          output += `// [Template] ç›®æ ‡ DOM å…ƒç´ :\n${step.source}\n\n`;
        }

        // æ·»åŠ çˆ¶å­ç»„ä»¶çš„è°ƒç”¨å…³ç³»
        if (step.callSnippet) {
          output += `// [Data Flow] æ¨¡æ¿ä¸­è°ƒç”¨å­ç»„ä»¶çš„ä»£ç :\n${step.callSnippet}\n\n`;
        }

        // æ·»åŠ å…³è”çš„è„šæœ¬é€»è¾‘
        output += `// [Logic] å…³è”çš„è„šæœ¬é€»è¾‘:\n${step.prunedScript || '// (è¯¥å±‚çº§æ— ç›¸å…³è„šæœ¬é€»è¾‘)'}`;
        return output;
      })
      .join('\n\n' + '='.repeat(25) + '\n\n');

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // Phase 8: è°ƒç”¨ AI åˆ†æ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    /**
     * AI åˆ†ææµç¨‹
     *
     * æŠŠè¿½è¸ªåˆ°çš„ä»£ç ç‰‡æ®µå‘é€ç»™å¤§æ¨¡å‹ï¼Œè®©å®ƒï¼š
     * 1. ç†è§£æ•°æ®çš„å®Œæ•´æµè½¬è·¯å¾„
     * 2. è¯†åˆ«æ•°æ®æºç±»å‹ï¼ˆAPI/Vuex/é™æ€ï¼‰
     * 3. ç”Ÿæˆç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Š
     */
    const finalTrace = [...traceChain].reverse();
    const originalTargetElement = finalTrace[0]?.source || 'æœªçŸ¥å…ƒç´ ';

    ctx.logger.info('--- å¯åŠ¨ AI æ™ºèƒ½é€»è¾‘åˆ†æ ---');
    ctx.logger.info(`[ç‚¹å‡»å…ƒç´ ] ${originalTargetElement}`);

    // è°ƒç”¨ LLM æœåŠ¡è¿›è¡Œæ™ºèƒ½åˆ†æ
    const aiAnalysis = await ctx.service.llm.analyze({
      finalCodeForAI,
      targetElement: originalTargetElement,
      traceChain: finalTrace,
    });

    // åœ¨ç»“æœä¸­è¿½åŠ ç‚¹å‡»å…ƒç´ ä¿¡æ¯ï¼Œæ–¹ä¾¿ç”¨æˆ·åŒºåˆ†å¤šæ¬¡ç‚¹å‡»çš„ç»“æœ
    const enrichedAnalysis = {
      ...aiAnalysis,
      clickedElement: originalTargetElement,
    };

    ctx.logger.info('--- AI æ™ºèƒ½é€»è¾‘ç»“æœ ---');
    ctx.logger.info(`[ç‚¹å‡»å…ƒç´ ] ${originalTargetElement}`);
    ctx.logger.info(enrichedAnalysis);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // Phase 9: æ„é€ æœ€ç»ˆè¿”å›ç»“æœ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    /**
     * è¿”å›ç»“æ„è¯´æ˜
     *
     * @returns {Object} åˆ†æç»“æœ
     * @property {string} message - çŠ¶æ€æ¶ˆæ¯
     * @property {string} targetElement - ç”¨æˆ·ç‚¹å‡»çš„ DOM å…ƒç´ æºç 
     * @property {Array} traceChain - å®Œæ•´çš„è¿½è¸ªé“¾
     * @property {Object} aiAnalysis - AI ç”Ÿæˆçš„åˆ†ææŠ¥å‘Š
     * @property {string} finalCodeForAI - å‘é€ç»™ AI çš„ä»£ç æ–‡æœ¬
     */
    return {
      message: 'åˆ†ææˆåŠŸ',
      targetElement: originalTargetElement,
      traceChain,
      aiAnalysis: enrichedAnalysis,
      finalCodeForAI,
    };
  }

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // è¾…åŠ©æ–¹æ³•
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  /**
   * æ„å»ºé™æ€å†…å®¹ç»“æœ
   *
   * ğŸ“ ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ç‚¹å‡»çš„æ˜¯å†™æ­»çš„é™æ€æ–‡æœ¬ï¼Œå¦‚ <span>Alipay</span>
   *
   * @param {string} file - æ–‡ä»¶è·¯å¾„
   * @param {string} tag - æ ‡ç­¾å
   * @param {string} source - å…ƒç´ æºç 
   * @returns {Object} é™æ€å†…å®¹åˆ†æç»“æœ
   *
   * ğŸ“Š ç¤ºä¾‹ï¼š
   *
   *   ç”¨æˆ·ç‚¹å‡»ï¼š<span>Alipay</span>
   *
   *   è¿”å›ï¼š
   *   {
   *     message: 'é™æ€å†…å®¹',
   *     targetElement: '<span>Alipay</span>',
   *     traceChain: [{...}],
   *     aiAnalysis: {
   *       dataSource: { type: 'static', description: 'å†™æ­»çš„é™æ€æ–‡æœ¬' }
   *     }
   *   }
   */
  buildStaticContentResult(file, tag, source) {
    return {
      message: 'é™æ€å†…å®¹',
      targetElement: source,
      traceChain: [{
        file,
        tag,
        source,
        prunedScript: '',
        callSnippet: '',
      }],
      aiAnalysis: {
        fullLinkTrace: 'è¯¥å…ƒç´ ä¸ºé™æ€å†…å®¹ï¼Œæ— éœ€è¿½è¸ªæ•°æ®æ¥æº',
        dataSource: {
          type: 'static',
          description: 'å†™æ­»çš„é™æ€æ–‡æœ¬ï¼Œä¸æ¶‰åŠåŠ¨æ€æ•°æ®',
        },
        componentAnalysis: [{
          file,
          role: 'å±•ç¤ºé™æ€å†…å®¹',
          dataFlow: 'æ— æ•°æ®æµè½¬',
        }],
      },
      finalCodeForAI: '',
    };
  }

  /**
   * æ„å»º Vuex è¿½è¸ªä¿¡æ¯
   *
   * ğŸ“ ä½¿ç”¨åœºæ™¯ï¼šå˜é‡æ¥è‡ª Vuex çš„ mapState/mapGetters
   *
   * @param {Object} vuexMapping - Vuex æ˜ å°„ä¿¡æ¯
   * @param {string} vuexMapping.namespace - æ¨¡å—å‘½åç©ºé—´ï¼ˆå¦‚ 'user'ï¼‰
   * @param {string} vuexMapping.type - æ˜ å°„ç±»å‹ï¼ˆ'state' æˆ– 'getter'ï¼‰
   * @param {string} vuexMapping.key - æ˜ å°„çš„é”®å
   * @param {string} storeSource - Store æ¨¡å—çš„æºç 
   * @param {string} projectRoot - é¡¹ç›®æ ¹ç›®å½•
   * @returns {Object} Vuex è¿½è¸ªå±‚çº§ä¿¡æ¯
   *
   * ğŸ“Š ç¤ºä¾‹ï¼š
   *
   *   ç»„ä»¶ä¸­ï¼š...mapState('user', ['userInfo'])
   *
   *   è¿”å›ï¼š
   *   {
   *     file: 'src/store/modules/user.js',
   *     tag: 'VuexStore',
   *     source: 'state: { userInfo: null }',
   *     prunedScript: 'å®Œæ•´çš„ store ç›¸å…³ä»£ç ',
   *     callSnippet: '',
   *     isVuex: true,
   *     vuexInfo: { namespace: 'user', type: 'state', key: 'userInfo' }
   *   }
   */
  buildVuexTraceInfo(vuexMapping, storeSource, projectRoot) {
    const { namespace, type, key } = vuexMapping;

    // æ„å»º Store æ–‡ä»¶è·¯å¾„
    const storeFile = namespace
      ? `src/store/modules/${namespace}.js`
      : 'src/store/index.js';

    // æŸ¥æ‰¾å¯èƒ½ä¿®æ”¹è¿™ä¸ª state çš„ mutations
    const mutationTriggers = findMutationTriggers(projectRoot, namespace, key);

    return {
      file: storeFile,
      tag: 'VuexStore',
      source: storeSource,
      prunedScript: storeSource,
      callSnippet: '',
      isVuex: true,
      vuexInfo: {
        namespace,
        type,
        key,
        mutationTriggers,  // å“ªäº›åœ°æ–¹è§¦å‘äº† mutation
      },
    };
  }
}

module.exports = TraceService;

