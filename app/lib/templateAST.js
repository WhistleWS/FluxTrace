/**
 * templateAST.js - Vue æ¨¡æ¿ AST èŠ‚ç‚¹æŸ¥æ‰¾å·¥å…·
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ®ç”¨æˆ·ç‚¹å‡»çš„è¡Œåˆ—åæ ‡ï¼Œåœ¨æ¨¡æ¿ AST ä¸­å®šä½å¯¹åº”çš„ DOM èŠ‚ç‚¹
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“š æŠ€æœ¯èƒŒæ™¯ï¼šä»€ä¹ˆæ˜¯ ASTï¼Ÿ
 *
 * AST (Abstract Syntax Tree) æŠ½è±¡è¯­æ³•æ ‘ï¼Œæ˜¯ä»£ç çš„æ ‘å½¢ç»“æ„è¡¨ç¤ºã€‚
 *
 * ä¸¾ä¾‹ï¼šè¿™æ®µ HTML æ¨¡æ¿
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  <div class="container">       â”‚
 * â”‚    <span>{{ name }}</span>     â”‚
 * â”‚  </div>                        â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ä¼šè¢«è§£ææˆè¿™æ ·çš„ AST æ ‘ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  {                                                         â”‚
 * â”‚    type: 1,              // 1 = å…ƒç´ èŠ‚ç‚¹                   â”‚
 * â”‚    tag: "div",           // æ ‡ç­¾å                         â”‚
 * â”‚    attrs: [...],         // å±æ€§åˆ—è¡¨                       â”‚
 * â”‚    children: [           // å­èŠ‚ç‚¹                         â”‚
 * â”‚      {                                                     â”‚
 * â”‚        type: 1,                                            â”‚
 * â”‚        tag: "span",                                        â”‚
 * â”‚        children: [                                         â”‚
 * â”‚          {                                                 â”‚
 * â”‚            type: 2,      // 2 = æ’å€¼è¡¨è¾¾å¼ {{ }}           â”‚
 * â”‚            expression: "name"                              â”‚
 * â”‚          }                                                 â”‚
 * â”‚        ]                                                   â”‚
 * â”‚      }                                                     â”‚
 * â”‚    ]                                                       â”‚
 * â”‚  }                                                         â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“Š Vue2 vs Vue3 AST å·®å¼‚ï¼š
 *
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚   ç‰¹æ€§      â”‚       Vue2              â”‚       Vue3              â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ ä½ç½®ä¿¡æ¯    â”‚ start/end (å­—ç¬¦åç§»é‡)  â”‚ loc.start/end (è¡Œåˆ—å·)  â”‚
 * â”‚ å±æ€§å­˜å‚¨    â”‚ attrsList               â”‚ props                   â”‚
 * â”‚ æ’å€¼ç±»å‹    â”‚ type === 2              â”‚ type === 5              â”‚
 * â”‚ è§£æå™¨      â”‚ vue-template-compiler   â”‚ @vue/compiler-core      â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“Š åæ ‡è½¬æ¢æµç¨‹å›¾ï¼š
 *
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  è¾“å…¥ï¼š(line, column) è¡Œåˆ—åæ ‡              â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                   â”‚
 *     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *     â”‚  åˆ¤æ–­ AST ç‰ˆæœ¬             â”‚
 *     â”‚  (é€šè¿‡ node.loc åˆ¤æ–­)      â”‚
 *     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                   â”‚
 *          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
 *          â”‚                 â”‚
 *     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
 *     â”‚  Vue3    â”‚      â”‚  Vue2    â”‚
 *     â”‚  (æœ‰ loc)â”‚      â”‚ (æ—  loc) â”‚
 *     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
 *          â”‚                â”‚
 *          â”‚                â”‚
 *     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *     â”‚ ç›´æ¥ä½¿ç”¨ â”‚      â”‚ éœ€è¦åæ ‡è½¬æ¢         â”‚
 *     â”‚ è¡Œåˆ—åæ ‡ â”‚      â”‚ (line,col) â†’ offset  â”‚
 *     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *          â”‚                â”‚
 *          â”‚           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *          â”‚           â”‚ 1. æ„å»ºè¡Œèµ·å§‹åç§»è¡¨ â”‚
 *          â”‚           â”‚    [0, 15, 42, ...] â”‚
 *          â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *          â”‚                â”‚
 *          â”‚           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *          â”‚           â”‚ 2. è®¡ç®—å­—ç¬¦åç§»é‡   â”‚
 *          â”‚           â”‚    offset = lineèµ·å§‹ â”‚
 *          â”‚           â”‚           + column   â”‚
 *          â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *          â”‚                â”‚
 *     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *     â”‚  é€’å½’æŸ¥æ‰¾åŒ¹é…çš„ AST èŠ‚ç‚¹       â”‚
 *     â”‚  (æ·±åº¦ä¼˜å…ˆï¼Œè¿”å›æœ€ç²¾ç¡®çš„èŠ‚ç‚¹)  â”‚
 *     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                      â”‚
 *                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
 *                 â”‚  è¿”å›èŠ‚ç‚¹ â”‚
 *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// å¸¸é‡å®šä¹‰
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/**
 * AST èŠ‚ç‚¹ç±»å‹å¸¸é‡
 *
 * ğŸ“ Vue æ¨¡æ¿ç¼–è¯‘å™¨ä¼šç»™ä¸åŒç±»å‹çš„èŠ‚ç‚¹åˆ†é…ä¸åŒçš„ type å€¼
 */
const NODE_TYPES = {
    ELEMENT: 1,           // å…ƒç´ èŠ‚ç‚¹ï¼Œå¦‚ <div>ã€<span>
    TEXT_WITH_EXPRESSION: 2,  // Vue2: åŒ…å«æ’å€¼çš„æ–‡æœ¬ï¼Œå¦‚ "Hello {{ name }}"
    INTERPOLATION: 5,     // Vue3: æ’å€¼è¡¨è¾¾å¼ï¼Œå¦‚ {{ name }}
};

/**
 * æ„å»ºæ¯è¡Œçš„èµ·å§‹å­—ç¬¦åç§»é‡è¡¨
 * @param {string} source - æ¨¡æ¿æºç 
 * @returns {number[]} æ¯è¡Œèµ·å§‹ä½ç½®çš„åç§»é‡æ•°ç»„
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 *
 * Vue2 çš„ AST ä½¿ç”¨å­—ç¬¦åç§»é‡ï¼ˆoffsetï¼‰æ¥æ ‡è®°èŠ‚ç‚¹ä½ç½®ï¼Œ
 * ä½†ç”¨æˆ·ç‚¹å‡»æ—¶æˆ‘ä»¬æ‹¿åˆ°çš„æ˜¯è¡Œåˆ—å·ï¼ˆline, columnï¼‰ã€‚
 * éœ€è¦æŠŠè¡Œåˆ—å·è½¬æ¢æˆåç§»é‡æ‰èƒ½å®šä½èŠ‚ç‚¹ã€‚
 *
 * ğŸ“Š ç¤ºä¾‹ï¼š
 *
 *   æºç ï¼ˆæ¯ä¸ªå­—ç¬¦éƒ½æœ‰ä¸€ä¸ªåç§»é‡ï¼‰ï¼š
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  ä½ç½®:  0 1 2 3 4 5 6 7 8 9 ...         â”‚
 *   â”‚  å†…å®¹:  < d i v > \n < s p a n > ...    â”‚
 *   â”‚         â†‘ ç¬¬1è¡Œ    â†‘ ç¬¬2è¡Œ               â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 *   è¡Œåç§»é‡è¡¨ï¼š
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  lineOffsets = [0, 6, 18, ...]         â”‚
 *   â”‚                 â†‘  â†‘   â†‘               â”‚
 *   â”‚              ç¬¬1è¡Œ ç¬¬2è¡Œ ç¬¬3è¡Œ èµ·å§‹ä½ç½®  â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 *   è®¡ç®—ç¬¬2è¡Œç¬¬3åˆ—çš„åç§»é‡ï¼š
 *   offset = lineOffsets[1] + 3 = 6 + 3 = 9
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
function buildLineOffsets(source) {
    // ç¬¬ä¸€è¡Œä»åç§»é‡ 0 å¼€å§‹
    const offsets = [0];

    // éå†æºç ï¼Œè®°å½•æ¯ä¸ªæ¢è¡Œç¬¦åçš„ä½ç½®
    for (let i = 0; i < source.length; i++) {
        // 10 æ˜¯æ¢è¡Œç¬¦ \n çš„ ASCII ç 
        if (source.charCodeAt(i) === 10) {
            // æ¢è¡Œç¬¦åé¢å°±æ˜¯ä¸‹ä¸€è¡Œçš„èµ·å§‹ä½ç½®
            offsets.push(i + 1);
        }
    }

    return offsets;
}

/**
 * å°†è¡Œåˆ—åæ ‡è½¬æ¢ä¸ºå­—ç¬¦åç§»é‡
 * @param {number} line - è¡Œå·ï¼ˆ1-basedï¼‰
 * @param {number} column - åˆ—å·ï¼ˆ0-basedï¼‰
 * @param {number[]} lineOffsets - è¡Œåç§»é‡è¡¨
 * @returns {number[]} å¯èƒ½çš„åç§»é‡å€™é€‰ï¼ˆå…¼å®¹ä¸åŒåæ ‡ç³»ç»Ÿï¼‰
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“ ä¸ºä»€ä¹ˆè¿”å›ä¸¤ä¸ªåç§»é‡ï¼Ÿ
 *
 * ä¸åŒçš„å·¥å…·å¯¹"åˆ—å·"çš„å®šä¹‰ä¸ä¸€è‡´ï¼š
 * - VSCode ç‚¹å‡»äº‹ä»¶ï¼šåˆ—å·ä» 1 å¼€å§‹ (1-based)
 * - æŸäº›è§£æå™¨å†…éƒ¨ï¼šåˆ—å·ä» 0 å¼€å§‹ (0-based)
 *
 * ä¸ºäº†å…¼å®¹è¿™ç§å·®å¼‚ï¼Œæˆ‘ä»¬åŒæ—¶è¿”å›ä¸¤ä¸ªå€™é€‰å€¼ï¼Œéƒ½å°è¯•ä¸€ä¸‹ã€‚
 *
 * ğŸ“Š ç¤ºä¾‹ï¼š
 *
 *   ç”¨æˆ·ç‚¹å‡»ç¬¬ 2 è¡Œç¬¬ 5 åˆ—ï¼ˆ1-basedï¼‰
 *   lineOffsets = [0, 10, 25]  // ç¬¬2è¡Œä»åç§»é‡10å¼€å§‹
 *
 *   è¿”å›å€¼ï¼š
 *   [10 + 5, 10 + 4] = [15, 14]
 *    â†‘ 1-based   â†‘ 0-based
 *
 *   å®šä½æ—¶ä¼šä¾æ¬¡å°è¯•è¿™ä¸¤ä¸ªåç§»é‡
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
function lineColumnToOffsets(line, column, lineOffsets) {
    // è¡Œå·è½¬ç´¢å¼•ï¼ˆline æ˜¯ 1-basedï¼Œæ•°ç»„æ˜¯ 0-basedï¼‰
    const lineIndex = Math.max(0, line - 1);

    // è·å–è¯¥è¡Œçš„èµ·å§‹åç§»é‡
    const lineStart = lineOffsets[lineIndex] ?? 0;

    // è®¡ç®—ä¸¤ä¸ªå€™é€‰åç§»é‡ï¼ˆå…¼å®¹ 0-based å’Œ 1-based åˆ—å·ï¼‰
    const offsetWithColumn = lineStart + Math.max(0, column);
    const offsetWithColumnMinusOne = lineStart + Math.max(0, column - 1);

    return [offsetWithColumn, offsetWithColumnMinusOne];
}

/**
 * Vue3 AST èŠ‚ç‚¹æŸ¥æ‰¾ï¼ˆä½¿ç”¨è¡Œåˆ—åæ ‡ï¼‰
 * @param {Object} node - Vue3 AST èŠ‚ç‚¹
 * @param {number} line - ç›®æ ‡è¡Œå·
 * @param {number} column - ç›®æ ‡åˆ—å·
 * @param {Object} parent - çˆ¶èŠ‚ç‚¹ï¼ˆç”¨äºç»´æŠ¤ parent é“¾ï¼‰
 * @returns {Object|null} åŒ¹é…çš„èŠ‚ç‚¹æˆ– null
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“ ç®—æ³•è¯´æ˜ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢ (DFS)
 *
 * ä¸ºä»€ä¹ˆç”¨ DFSï¼Ÿ
 * - ç”¨æˆ·ç‚¹å‡»çš„ä½ç½®å¯èƒ½åŒæ—¶åœ¨å¤šä¸ªåµŒå¥—èŠ‚ç‚¹çš„èŒƒå›´å†…
 * - æˆ‘ä»¬éœ€è¦è¿”å›"æœ€æ·±å±‚"çš„é‚£ä¸ªèŠ‚ç‚¹ï¼ˆæœ€ç²¾ç¡®çš„åŒ¹é…ï¼‰
 *
 * ğŸ“Š ç¤ºä¾‹ï¼š
 *
 *   æ¨¡æ¿ç»“æ„ï¼š
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  <div>                    è¡Œ1-3      â”‚
 *   â”‚    <span>Hello</span>     è¡Œ2        â”‚
 *   â”‚  </div>                              â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 *   ç”¨æˆ·ç‚¹å‡»è¡Œ2ï¼Œåæ ‡åŒæ—¶è½åœ¨ï¼š
 *   - div èŠ‚ç‚¹çš„èŒƒå›´å†…ï¼ˆè¡Œ1-3ï¼‰
 *   - span èŠ‚ç‚¹çš„èŒƒå›´å†…ï¼ˆè¡Œ2ï¼‰
 *
 *   æˆ‘ä»¬åº”è¯¥è¿”å› spanï¼ˆæ›´ç²¾ç¡®ï¼‰
 *
 * ğŸ“Š åæ ‡åˆ¤æ–­å›¾è§£ï¼š
 *
 *   ç¬¬3è¡Œ |  <div class="foo">     â† start.line=3, start.column=2
 *   ç¬¬4è¡Œ |    å†…å®¹                 â† ä¸­é—´è¡Œï¼Œåªæ£€æŸ¥è¡Œå·
 *   ç¬¬5è¡Œ |  </div>                â† end.line=5, end.column=8
 *
 *   åˆ¤æ–­è§„åˆ™ï¼š
 *   - é¦–è¡Œï¼šè¡Œå·åŒ¹é… ä¸” åˆ—å· >= start.column
 *   - ä¸­é—´è¡Œï¼šåªè¦è¡Œå·åœ¨èŒƒå›´å†…å°±ç®—åŒ¹é…
 *   - æœ«è¡Œï¼šè¡Œå·åŒ¹é… ä¸” åˆ—å· <= end.column
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
function findNodeVue3(node, line, column, parent = null) {
    // èŠ‚ç‚¹æ— æ•ˆæˆ–æ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼Œè·³è¿‡
    if (!node || !node.loc) return null;

    // ç»´æŠ¤ parent æŒ‡é’ˆï¼Œä¾¿äºåç»­å˜é‡æº¯æºï¼ˆå¦‚ v-for åˆ«åè§£æï¼‰
    node.parent = parent;

    const { start, end } = node.loc;

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // åˆ¤æ–­ç›®æ ‡åæ ‡æ˜¯å¦åœ¨èŠ‚ç‚¹èŒƒå›´å†…
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    const isInside = isPositionInRange(line, column, start, end);

    if (!isInside) return null;

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ·±åº¦ä¼˜å…ˆï¼šä¼˜å…ˆåœ¨å­èŠ‚ç‚¹ä¸­æŸ¥æ‰¾ï¼ˆè¿”å›æ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if (node.children && node.children.length > 0) {
        for (const child of node.children) {
            const found = findNodeVue3(child, line, column, node);
            if (found) return found;
        }
    }

    // å­èŠ‚ç‚¹ä¸­æ²¡æ‰¾åˆ°ï¼Œæ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºå…ƒç´ èŠ‚ç‚¹
    if (node.type === NODE_TYPES.ELEMENT) {
        return node;
    }

    return null;
}

/**
 * åˆ¤æ–­åæ ‡æ˜¯å¦åœ¨èŠ‚ç‚¹èŒƒå›´å†…
 * @param {number} line - ç›®æ ‡è¡Œå·
 * @param {number} column - ç›®æ ‡åˆ—å·
 * @param {Object} start - èµ·å§‹ä½ç½® { line, column }
 * @param {Object} end - ç»“æŸä½ç½® { line, column }
 * @returns {boolean} æ˜¯å¦åœ¨èŒƒå›´å†…
 */
function isPositionInRange(line, column, start, end) {
    // è¡Œå·ä¸åœ¨èŒƒå›´å†…
    if (line < start.line || line > end.line) {
        return false;
    }

    // å¦‚æœåœ¨é¦–è¡Œï¼Œåˆ—å·å¿…é¡» >= èµ·å§‹åˆ—
    if (line === start.line && column < start.column) {
        return false;
    }

    // å¦‚æœåœ¨æœ«è¡Œï¼Œåˆ—å·å¿…é¡» <= ç»“æŸåˆ—
    if (line === end.line && column > end.column) {
        return false;
    }

    return true;
}

/**
 * Vue2 AST èŠ‚ç‚¹æŸ¥æ‰¾ï¼ˆä½¿ç”¨å­—ç¬¦åç§»é‡ï¼‰
 * @param {Object} node - Vue2 AST èŠ‚ç‚¹
 * @param {number} line - ç›®æ ‡è¡Œå·
 * @param {number} column - ç›®æ ‡åˆ—å·
 * @param {string} templateSource - æ¨¡æ¿æºç 
 * @param {Object} parent - çˆ¶èŠ‚ç‚¹ï¼ˆç”¨äºç»´æŠ¤ parent é“¾ï¼‰
 * @returns {Object|null} åŒ¹é…çš„èŠ‚ç‚¹æˆ– null
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“ Vue2 ä¸ Vue3 çš„åŒºåˆ«
 *
 * Vue2 çš„ AST èŠ‚ç‚¹ä½¿ç”¨å­—ç¬¦åç§»é‡ï¼ˆstart/endï¼‰è€Œä¸æ˜¯è¡Œåˆ—å·ã€‚
 * æ‰€ä»¥éœ€è¦å…ˆæŠŠè¡Œåˆ—å·è½¬æ¢æˆåç§»é‡ï¼Œå†è¿›è¡ŒåŒ¹é…ã€‚
 *
 * ğŸ“Š è½¬æ¢è¿‡ç¨‹ï¼š
 *
 *   è¾“å…¥: line=2, column=5
 *         â†“
 *   [buildLineOffsets] æ„å»ºè¡Œåç§»è¡¨
 *         â†“
 *   [lineColumnToOffsets] è½¬æ¢ä¸ºåç§»é‡
 *         â†“
 *   è¾“å‡º: offset=15 (æˆ–å€™é€‰å€¼ [15, 14])
 *         â†“
 *   [findByOffset] ç”¨åç§»é‡åŒ¹é…èŠ‚ç‚¹
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
function findNodeVue2(node, line, column, templateSource, parent = null) {
    if (!node || !templateSource) return null;

    // æ­¥éª¤1ï¼šæ„å»ºè¡Œåç§»é‡è¡¨
    const lineOffsets = buildLineOffsets(templateSource);

    // æ­¥éª¤2ï¼šå°†è¡Œåˆ—åæ ‡è½¬æ¢ä¸ºå­—ç¬¦åç§»é‡ï¼ˆè¿”å›å¤šä¸ªå€™é€‰å€¼ï¼‰
    const targetOffsets = lineColumnToOffsets(line, column, lineOffsets);

    /**
     * å†…éƒ¨é€’å½’å‡½æ•°ï¼šæ ¹æ®åç§»é‡æŸ¥æ‰¾èŠ‚ç‚¹
     * @param {Object} current - å½“å‰èŠ‚ç‚¹
     * @param {number} offset - ç›®æ ‡åç§»é‡
     * @param {Object} parentNode - çˆ¶èŠ‚ç‚¹
     */
    const findByOffset = (current, offset, parentNode) => {
        if (!current) return null;

        // è·å–èŠ‚ç‚¹çš„èµ·æ­¢åç§»é‡
        const start = typeof current.start === 'number' ? current.start : null;
        const end = typeof current.end === 'number' ? current.end : null;

        // æ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼Œè·³è¿‡
        if (start === null || end === null) return null;

        // åˆ¤æ–­åç§»é‡æ˜¯å¦åœ¨èŠ‚ç‚¹èŒƒå›´å†…
        const isInside = offset >= start && offset <= end;
        if (!isInside) return null;

        // ç»´æŠ¤ parent é“¾ï¼ˆç”¨äºåç»­ v-for åˆ«åæº¯æºï¼‰
        if (parentNode) current.parent = parentNode;

        // æ·±åº¦ä¼˜å…ˆï¼šä¼˜å…ˆåœ¨å­èŠ‚ç‚¹ä¸­æŸ¥æ‰¾
        if (Array.isArray(current.children) && current.children.length > 0) {
            for (const child of current.children) {
                const found = findByOffset(child, offset, current);
                if (found) return found;
            }
        }

        // å­èŠ‚ç‚¹æ²¡æ‰¾åˆ°ï¼Œæ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºå…ƒç´ èŠ‚ç‚¹
        if (current.type === NODE_TYPES.ELEMENT) {
            return current;
        }

        return null;
    };

    // æ­¥éª¤3ï¼šå°è¯•å¤šä¸ªå€™é€‰åç§»é‡ï¼ˆå…¼å®¹ä¸åŒåæ ‡ç³»ç»Ÿï¼‰
    for (const offset of targetOffsets) {
        const found = findByOffset(node, offset, parent);
        if (found) return found;
    }

    return null;
}

/**
 * ä¸»å‡½æ•°ï¼šåœ¨æ¨¡æ¿ AST ä¸­æŸ¥æ‰¾åŒ¹é…è¡Œåˆ—åæ ‡çš„èŠ‚ç‚¹
 * @param {Object} node - AST æ ¹èŠ‚ç‚¹
 * @param {number} line - ç›®æ ‡è¡Œå·
 * @param {number} column - ç›®æ ‡åˆ—å·
 * @param {Object} parent - çˆ¶èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰
 * @param {string} templateSource - æ¨¡æ¿æºç ï¼ˆVue2 å¿…éœ€ï¼‰
 * @returns {Object|null} åŒ¹é…çš„èŠ‚ç‚¹æˆ– null
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“ è¿™æ˜¯å¯¹å¤–æš´éœ²çš„å”¯ä¸€æ¥å£
 *
 * å†…éƒ¨ä¼šè‡ªåŠ¨åˆ¤æ–­ AST ç‰ˆæœ¬ï¼ˆVue2/Vue3ï¼‰ï¼Œé€‰æ‹©å¯¹åº”çš„æŸ¥æ‰¾ç­–ç•¥ã€‚
 *
 * ğŸ“Š ä½¿ç”¨ç¤ºä¾‹ï¼š
 *
 *   // Vue3 é¡¹ç›®ï¼ˆAST èŠ‚ç‚¹æœ‰ loc å±æ€§ï¼‰
 *   const node = findNodeInTemplate(vue3Ast, 5, 10);
 *
 *   // Vue2 é¡¹ç›®ï¼ˆAST èŠ‚ç‚¹åªæœ‰ start/end åç§»é‡ï¼Œéœ€è¦ä¼ å…¥æºç ï¼‰
 *   const node = findNodeInTemplate(vue2Ast, 5, 10, null, templateSource);
 *
 * ğŸ“Š è¿”å›å€¼ç»“æ„ï¼ˆVue3 å…ƒç´ èŠ‚ç‚¹ç¤ºä¾‹ï¼‰ï¼š
 *
 *   {
 *     type: 1,                    // å…ƒç´ èŠ‚ç‚¹
 *     tag: "div",                 // æ ‡ç­¾å
 *     props: [...],               // å±æ€§åˆ—è¡¨
 *     children: [...],            // å­èŠ‚ç‚¹
 *     loc: {                      // ä½ç½®ä¿¡æ¯
 *       start: { line: 5, column: 2 },
 *       end: { line: 5, column: 20 }
 *     },
 *     parent: { ... }             // çˆ¶èŠ‚ç‚¹å¼•ç”¨ï¼ˆæˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ çš„ï¼‰
 *   }
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
function findNodeInTemplate(node, line, column, parent = null, templateSource = null) {
    if (!node) return null;

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // è‡ªåŠ¨åˆ¤æ–­ AST ç‰ˆæœ¬
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // Vue3 çš„ AST èŠ‚ç‚¹æœ‰ loc å±æ€§ï¼ˆåŒ…å«è¡Œåˆ—ä¿¡æ¯ï¼‰
    // Vue2 çš„ AST èŠ‚ç‚¹åªæœ‰ start/end å±æ€§ï¼ˆå­—ç¬¦åç§»é‡ï¼‰
    const isVue3 = !!node.loc;

    if (isVue3) {
        // Vue3ï¼šç›´æ¥ä½¿ç”¨è¡Œåˆ—åæ ‡æŸ¥æ‰¾
        return findNodeVue3(node, line, column, parent);
    } else {
        // Vue2ï¼šéœ€è¦å…ˆè½¬æ¢åæ ‡ï¼Œå†ç”¨åç§»é‡æŸ¥æ‰¾
        return findNodeVue2(node, line, column, templateSource, parent);
    }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// æ¨¡å—å¯¼å‡º
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

module.exports = {
    findNodeInTemplate,
    // ä»¥ä¸‹å‡½æ•°ä¹Ÿå¯¼å‡ºï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•
    NODE_TYPES,
    buildLineOffsets,
    lineColumnToOffsets,
    isPositionInRange,
};
