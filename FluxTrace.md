# AI Trace：全链路数据流转分析系统

AI Trace 旨在解决大型 Vue 项目中“从 UI 元素到后端字段”的溯源难题，通过 Webpack 依赖分析、AST 源码提纯与 LLM 智能逻辑分析，实现代码级的数据全链路追踪。

---

## 1. 核心架构与效能指标

| 层级 | 核心技术 | 功能目标 | 减负/准确率 |
| :--- | :--- | :--- | :--- |
| **精准定位层** | Webpack 依赖图 | 缩小分析范围至目标链路文件 | 99% (200w+ -> 2w+ 行) |
| **源码提纯层** | AST (Babel) | 提取关键源码片段，最大化 Token 利用率 | 90% (2w+ -> 2k+ 行) |
| **大模型分析层** | LLM (Prompt) | 识别业务逻辑、数据流转、接口依赖
| **全链路数据层** | 数据映射 | 前后端链路打通，字段级精准溯源 | 端到端视图 |

---

## 2. 技术栈选型

- **前端分析：** `@vue/compiler-sfc`、`vue-template-compiler`
- **AST 解析：** `@babel/parser`、`@babel/traverse`、`@babel/generator`
- **依赖溯源：** Webpack Compilation API
- **后端框架：** Egg.js

---

## 3. 核心实现流程

### 3.1 精准定位层：从 DOM 到源码映射
1. **DOM 精准定位：**
   - 基于 Vue SFC 解析，将页面元素映射至源码文件及行号。
   - 流程：捕获元素信息 -> 解析 `.vue` 文件 -> AST 递归查找目标 DOM -> 返回定位结果。
2. **Webpack 依赖引擎：**
   - 读取 `webpack.config.js`，通过 `compilation` 对象获取模块依赖图。
   - 构建**双向依赖关系**（正向引用 + 反向追溯）。
   - **优化：** 引入基于 Git Commit Hash 的智能缓存机制。
3. **调用链追踪：**
   - 从目标文件出发，反向追溯至 Entry 入口，向下识别关联子组件与工具函数。

### 3.2 源码提纯层：Token 极简化处理
通过 AST 两次提纯，将 2 万行代码缩减至 2000 行以内。

#### A. Template 提纯
- **逻辑：** 编译 Template 生成 AST，提取目标节点及其所有父节点以保留上下文。
- **输出：** 精简 HTML 结构 + 响应式变量列表（插值、属性绑定、指令、事件）。

#### B. Script 提纯
- **逻辑：** 以变量列表为起点，递归收集依赖（A 依赖 B，则保留 B）。
- **处理：** 仅保留相关的生命周期钩子（created/mounted）和被引用的 `import` 语句。
- **重构：** 使用 `@babel/generator` 组合保留的节点，生成精简代码。

### 3.3 智能分析层：LLM 逻辑识别
采用**七层结构化 Prompt** 驱动大模型：
1. **结构：** 角色定义 -> 任务描述 -> 分析维度 -> 输出格式 (JSON) -> **提纯源码** -> 接口信息 -> 自校验。
2. **目标：** 突破静态分析局限，识别复杂的业务逻辑和动态数据加工过程。

---

## 4. 全链路数据追踪层
打通“前端响应式字段 -> 前端加工逻辑 -> 后端接口字段”的完整链路。后端通过 Trace 系统（如 Jaeger）打通下游子系统，实现端到端字段级精准溯源。